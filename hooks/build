#!/bin/bash
## https://docs.docker.com/docker-hub/builds/advanced/

## GIT_BRANCH equals both invoking branch or tag.
## Strip of a release suffix

gh_repo="kubernetes/kubernetes"
tag_re='v[0-9]+\.[0-9]+\.[0-9]+$'

kubectl_release="${GIT_BRANCH%-r*}" # strip suffix r12 (-r*)
pages=3
tags_file="/tmp/$$.tags_file"
:> $tags_file

cleanup(); { rm -f $tags_file; }
trap cleanup EXIT

## cycle through pages
pn=0
while [ $pn -le 10 ]; do
  tags=$(curl -L "https://api.github.com/repos/${gh_repo}/tags?page=${pn}" | jq -r '.[].name' | grep -E "$tag_re")
  echo "$tags" >> $tags_file
  if [ -z "$tags" ]; then break; fi
  pn=$((pn+1))
done

## get full latest version
latest_version=$(cat $tags_file | sort -nr | uniq | grep "v${kubectl_relases}" | head -n1)

docker build \
  --build-arg KUBECTL_VERSION=$latest_version \
  -t $IMAGE_NAME .
